name: Deploy Backend Softwave

on:
  push:
    branches: [ "release/sprint-final" ]
    
  pull_request:
    branches: [ "release/sprint-final" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/backend-softwave:latest
          # Mude o nome da tag acima para cada repositório diferente!

  deploy-private:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout para pegar o docker-compose (Apenas no repo principal)
        uses: actions/checkout@v3
        # Se este workflow estiver rodando num repo que NÃO tem o docker-compose, 
        # você precisará copiar o arquivo via SCP ou tê-lo já na EC2.
        # Assumindo que o arquivo docker-compose.yaml está neste repo ou na pasta da EC2.

      - name: Deploy to Private EC2 via Bastion
        uses: appleboy/ssh-action@v1.0.0
        with:
          # Conexão com o Bastion (Front EC2)
          host: ${{ secrets.EC2_HOST_PUBLIC }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # ProxyJump para chegar na privada
          proxy_host: ${{ secrets.EC2_HOST_PUBLIC }}
          proxy_username: ${{ secrets.EC2_USER }}
          proxy_key: ${{ secrets.EC2_SSH_KEY }}
          # O destino final (Private EC2)
          script_stop: true
          host_fingerprint: ignore
          # Este comando roda dentro da EC2 Privada:
          script: |
            # Configurar variaveis de ambiente num .env temporário para o compose ler
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" > .env
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
            
            # Garantir Docker instalado na privada
            if ! command -v docker &> /dev/null; then
                sudo yum update -y
                sudo yum install docker -y
                sudo service docker start
                sudo usermod -a -G docker ${{ secrets.EC2_USER }}
                # Instalar Docker Compose
                sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                sudo chmod +x /usr/local/bin/docker-compose
            fi

            # Se o docker-compose.yaml não estiver lá, você precisa criar ou copiar.
            # Supondo que você já copiou ou que este repo é o principal:
            # (Se não for o repo principal, pule a criação do arquivo e use o existente)
            
            # Atualizar as imagens
            docker-compose pull
            
            # Reiniciar todo o stack na ordem correta
            docker-compose up -d --remove-orphans
