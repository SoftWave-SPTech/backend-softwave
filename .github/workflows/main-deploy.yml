name: Build & Deploy Backend Softwave

on:
  push:
    branches: [ "release/sprint-final", "main" ]
  pull_request:
    branches: [ "release/sprint-final", "main" ]
  repository_dispatch:
    types: [ deploy ]

permissions:
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build JAR
        run: mvn -B clean package -DskipTests

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push Docker image
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/backend-softwave:latest

      - name: Set image output
        id: set-image
        run: echo "::set-output name=image::${{ secrets.DOCKERHUB_USERNAME }}/backend-softwave:latest"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Prepare key file from base64 (runner)
        shell: bash
        run: |
          # Decodifica o PEM vindo do secret base64 para um arquivo temporário no runner
          echo "${{ secrets.EC2_SSH_KEY_B64 }}" | base64 --decode > key_for_action.pem
          chmod 600 key_for_action.pem

      - name: Deploy via Bastion (appleboy with proxy)
        uses: appleboy/ssh-action@v0.1.8
        with:
          # Conecta *diretamente na privada* usando proxy jump no próprio action:
          host: ${{ secrets.EC2_HOST_PRIVATE }}      # alvo final (instância privada)
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}             # chave usada para conexão principal (appleboy usa essa para host)
          proxy_host: ${{ secrets.EC2_HOST_PUBLIC }}  # bastion public
          proxy_username: ${{ secrets.EC2_USER }}
          proxy_key: ${{ secrets.EC2_SSH_KEY }}       # mesma chave para o proxy (ou outra, se for o caso)
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 1h
          script_stop: true
          script: |
            set -euo pipefail
            echo ">>> Deploy iniciado via action (proxy jump) - $(date)"

            REMOTE_DIR="/home/${{ secrets.EC2_USER }}/app"
            # Cria .env no runner e copia via scp pelo action (opcional) - aqui pegamos secrets e geramos um .env no runner
            cat > .env.deploy <<EOF
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_SESSION_TOKEN=${{ secrets.AWS_SESSION_TOKEN }}
            PROJECT_NAME=${{ secrets.PROJECT_NAME || 'softwave' }}
            EOF
            # copia .env para o remoto (o appleboy/ssh-action expõe um SCP nativo por ssh dentro do container)
            scp -o StrictHostKeyChecking=no -o ProxyJump=${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST_PUBLIC }} -i key_for_action.pem .env.deploy ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST_PRIVATE }}:${REMOTE_DIR}/.env

            # agora executa comandos remotos (via ssh_action) para pull/up
            ssh -o StrictHostKeyChecking=no -o ProxyJump=${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST_PUBLIC }} -i key_for_action.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST_PRIVATE }} bash -s <<'REMOTE'
            set -euo pipefail
            cd "${REMOTE_DIR}" || { echo "Diretório ${REMOTE_DIR} não encontrado"; exit 1; }
            
            # Pull com retry
            attempts=0; max_attempts=5
            until [ $attempts -ge $max_attempts ]; do
              attempts=$((attempts+1))
              echo "[private] tentativa $attempts: docker compose pull"
              if docker compose pull; then break; fi
              sleep $((attempts * 5))
            done
            if [ $attempts -ge $max_attempts ]; then
              echo "Falha ao puxar imagens"
              exit 1
            fi
            
            docker compose up -d --remove-orphans
            echo "[private] deploy finalizado"
            REMOTE

            # cleanup no runner
            shred -u key_for_action.pem 2>/dev/null || rm -f key_for_action.pem
            shred -u .env.deploy 2>/dev/null || rm -f .env.deploy

            echo ">>> Deploy finalizado - $(date)"
